// Script de debug avan√ßado para diagnosticar problemas da extens√£o Lex
console.log('üîç === DIAGN√ìSTICO AVAN√áADO EXTENS√ÉO LEX ===');

// Fun√ß√£o principal de diagn√≥stico
function diagnosticarExtensaoLex() {
  const diagnostico = {
    timestamp: new Date().toISOString(),
    url: window.location.href,
    userAgent: navigator.userAgent,
    scripts: {},
    openaiClient: {},
    dom: {},
    timing: {},
    errors: []
  };

  console.log('üöÄ Iniciando diagn√≥stico completo...');

  // 1. Verificar carregamento de scripts
  console.log('üìú 1. VERIFICANDO SCRIPTS CARREGADOS');
  
  // Verificar se window.lexAssistantActive existe
  diagnostico.scripts.lexAssistantActive = !!window.lexAssistantActive;
  console.log(`   - window.lexAssistantActive: ${diagnostico.scripts.lexAssistantActive ? '‚úÖ' : '‚ùå'}`);
  
  // Verificar se window.openaiClient existe
  diagnostico.scripts.openaiClientExists = !!window.openaiClient;
  console.log(`   - window.openaiClient existe: ${diagnostico.scripts.openaiClientExists ? '‚úÖ' : '‚ùå'}`);
  
  // Verificar se window.pjeAssistantActive existe (do content.js)
  diagnostico.scripts.pjeAssistantActive = !!window.pjeAssistantActive;
  console.log(`   - window.pjeAssistantActive: ${diagnostico.scripts.pjeAssistantActive ? '‚úÖ' : '‚ùå'}`);

  // 2. Diagn√≥stico detalhado do OpenAI Client
  console.log('ü§ñ 2. DIAGN√ìSTICO OPENAI CLIENT');
  
  if (window.openaiClient) {
    try {
      diagnostico.openaiClient.exists = true;
      diagnostico.openaiClient.type = typeof window.openaiClient;
      diagnostico.openaiClient.constructor = window.openaiClient.constructor?.name;
      
      // Verificar m√©todos dispon√≠veis
      diagnostico.openaiClient.methods = Object.getOwnPropertyNames(window.openaiClient);
      console.log('   - M√©todos dispon√≠veis:', diagnostico.openaiClient.methods);
      
      // Verificar se est√° configurado
      if (typeof window.openaiClient.isConfigured === 'function') {
        diagnostico.openaiClient.configured = window.openaiClient.isConfigured();
        console.log(`   - Configurado: ${diagnostico.openaiClient.configured ? '‚úÖ' : '‚ùå'}`);
      } else {
        diagnostico.openaiClient.configured = null;
        console.log('   - M√©todo isConfigured n√£o encontrado ‚ùå');
      }
      
      // Verificar API key
      if (window.openaiClient.apiKey) {
        diagnostico.openaiClient.hasApiKey = true;
        diagnostico.openaiClient.apiKeyLength = window.openaiClient.apiKey.length;
        diagnostico.openaiClient.apiKeyPrefix = window.openaiClient.apiKey.substring(0, 10) + '...';
        diagnostico.openaiClient.isPlaceholder = window.openaiClient.apiKey === 'SUBSTITUA_PELA_SUA_CHAVE_OPENAI_AQUI';
        console.log(`   - API Key presente: ‚úÖ (${diagnostico.openaiClient.apiKeyLength} chars)`);
        console.log(`   - √â placeholder: ${diagnostico.openaiClient.isPlaceholder ? '‚ùå' : '‚úÖ'}`);
      } else {
        diagnostico.openaiClient.hasApiKey = false;
        console.log('   - API Key: ‚ùå N√£o encontrada');
      }
      
    } catch (error) {
      diagnostico.openaiClient.error = error.message;
      diagnostico.errors.push(`OpenAI Client Error: ${error.message}`);
      console.error('   - Erro ao analisar OpenAI Client:', error);
    }
  } else {
    diagnostico.openaiClient.exists = false;
    console.log('   - OpenAI Client: ‚ùå N√£o encontrado');
  }

  // 3. Verificar elementos DOM da extens√£o
  console.log('üé® 3. VERIFICANDO ELEMENTOS DOM');
  
  // Bot√µes da extens√£o
  const botaoLex = document.querySelector('.lex-button');
  const botaoPje = document.querySelector('[id^="pje-assistant-btn-"]');
  const chatContainer = document.querySelector('.lex-chat');
  
  diagnostico.dom.botaoLex = !!botaoLex;
  diagnostico.dom.botaoPje = !!botaoPje;
  diagnostico.dom.chatContainer = !!chatContainer;
  
  console.log(`   - Bot√£o Lex (.lex-button): ${diagnostico.dom.botaoLex ? '‚úÖ' : '‚ùå'}`);
  console.log(`   - Bot√£o PJe (pje-assistant-btn): ${diagnostico.dom.botaoPje ? '‚úÖ' : '‚ùå'}`);
  console.log(`   - Container Chat (.lex-chat): ${diagnostico.dom.chatContainer ? '‚úÖ' : '‚ùå'}`);

  // 4. Verificar informa√ß√µes do processo
  console.log('üìã 4. VERIFICANDO EXTRA√á√ÉO DE DADOS');
  
  const texto = document.body.innerText;
  const numeroMatch = texto.match(/(\d{7}-\d{2}\.\d{4}\.\d{1}\.\d{2}\.\d{4})/g);
  const tribunalMatch = texto.match(/TRIBUNAL DE JUSTI√áA/i);
  
  diagnostico.dom.numeroProcesso = numeroMatch ? numeroMatch[0] : null;
  diagnostico.dom.tribunal = tribunalMatch ? tribunalMatch[0] : null;
  
  console.log(`   - N√∫mero do processo: ${diagnostico.dom.numeroProcesso || '‚ùå N√£o encontrado'}`);
  console.log(`   - Tribunal: ${diagnostico.dom.tribunal || '‚ùå N√£o encontrado'}`);

  // 5. Verificar timing
  console.log('‚è±Ô∏è 5. AN√ÅLISE DE TIMING');
  
  diagnostico.timing.domReady = document.readyState;
  diagnostico.timing.pageLoadTime = performance.now();
  
  console.log(`   - DOM State: ${diagnostico.timing.domReady}`);
  console.log(`   - Page Load Time: ${diagnostico.timing.pageLoadTime.toFixed(2)}ms`);

  // 6. Resumo final
  console.log('üìä 6. RESUMO DO DIAGN√ìSTICO');
  
  const problemas = [];
  const sucessos = [];
  
  if (!diagnostico.scripts.openaiClientExists) {
    problemas.push('OpenAI Client n√£o carregado');
  } else {
    sucessos.push('OpenAI Client carregado');
  }
  
  if (diagnostico.openaiClient.isPlaceholder) {
    problemas.push('API Key n√£o configurada (ainda √© placeholder)');
  } else if (diagnostico.openaiClient.configured) {
    sucessos.push('API Key configurada');
  }
  
  if (!diagnostico.dom.botaoLex && !diagnostico.dom.botaoPje) {
    problemas.push('Nenhum bot√£o da extens√£o encontrado');
  } else {
    sucessos.push('Bot√£o da extens√£o encontrado');
  }
  
  console.log('‚úÖ SUCESSOS:');
  sucessos.forEach(sucesso => console.log(`   - ${sucesso}`));
  
  console.log('‚ùå PROBLEMAS:');
  problemas.forEach(problema => console.log(`   - ${problema}`));
  
  // Salvar diagn√≥stico globalmente para inspe√ß√£o
  window.diagnosticoLex = diagnostico;
  
  console.log('üíæ Diagn√≥stico completo salvo em window.diagnosticoLex');
  console.log('üîç Para ver o relat√≥rio completo, digite: console.log(window.diagnosticoLex)');
  
  return diagnostico;
}

// Executar diagn√≥stico ap√≥s carregamento
setTimeout(() => {
  diagnosticarExtensaoLex();
}, 3000);

// Executar diagn√≥stico adicional ap√≥s mais tempo
setTimeout(() => {
  console.log('üîÑ Executando diagn√≥stico adicional ap√≥s 10 segundos...');
  diagnosticarExtensaoLex();
}, 10000);

// Fun√ß√£o para for√ßar cria√ß√£o do bot√£o (para debug)
window.forcarCriacaoBotao = function() {
  console.log('For√ßando cria√ß√£o do bot√£o...');
  
  const botao = document.createElement('button');
  botao.id = 'pje-chat-toggle-debug';
  botao.innerHTML = 'üí¨ DEBUG';
  botao.style.cssText = `
    position: fixed !important;
    top: 10px !important;
    right: 10px !important;
    background: red !important;
    color: white !important;
    padding: 10px !important;
    border: none !important;
    border-radius: 5px !important;
    cursor: pointer !important;
    z-index: 999999 !important;
  `;
  
  botao.onclick = function() {
    alert('Bot√£o de debug funcionando!');
  };
  
  document.body.appendChild(botao);
  console.log('Bot√£o de debug criado!');
};

console.log('Para for√ßar cria√ß√£o do bot√£o, digite: forcarCriacaoBotao()');
// Fun√ß√£o e
spec√≠fica para testar OpenAI Client
function testarOpenAIClient() {
  console.log('üß™ === TESTE ESPEC√çFICO OPENAI CLIENT ===');
  
  const teste = {
    timestamp: new Date().toISOString(),
    clienteExiste: !!window.openaiClient,
    tentativasCarregamento: 0,
    maxTentativas: 20,
    intervalos: []
  };
  
  function verificarCliente() {
    teste.tentativasCarregamento++;
    const agora = Date.now();
    
    console.log(`üîÑ Tentativa ${teste.tentativasCarregamento}/${teste.maxTentativas}`);
    
    if (window.openaiClient) {
      console.log('‚úÖ OpenAI Client encontrado!');
      console.log('üìä Detalhes do cliente:');
      console.log('   - Tipo:', typeof window.openaiClient);
      console.log('   - Constructor:', window.openaiClient.constructor?.name);
      console.log('   - API Key configurada:', window.openaiClient.apiKey ? 'SIM' : 'N√ÉO');
      console.log('   - √â placeholder:', window.openaiClient.apiKey === 'SUBSTITUA_PELA_SUA_CHAVE_OPENAI_AQUI');
      
      if (typeof window.openaiClient.isConfigured === 'function') {
        console.log('   - isConfigured():', window.openaiClient.isConfigured());
      }
      
      // Testar uma chamada simples
      if (typeof window.openaiClient.analisarDocumento === 'function') {
        console.log('üß™ Testando m√©todo analisarDocumento...');
        window.openaiClient.analisarDocumento({}, 'teste')
          .then(resposta => {
            console.log('‚úÖ M√©todo analisarDocumento funcionou:', resposta.substring(0, 100) + '...');
          })
          .catch(erro => {
            console.log('‚ö†Ô∏è M√©todo analisarDocumento com erro (esperado se API key inv√°lida):', erro.message);
          });
      }
      
      teste.clienteExiste = true;
      teste.tempoTotal = agora - teste.inicioTeste;
      console.log(`‚è±Ô∏è Cliente carregado em ${teste.tempoTotal}ms`);
      
      window.testeOpenAI = teste;
      return;
    }
    
    if (teste.tentativasCarregamento >= teste.maxTentativas) {
      console.log('‚ùå OpenAI Client N√ÉO foi carregado ap√≥s', teste.maxTentativas, 'tentativas');
      console.log('üîç Poss√≠veis causas:');
      console.log('   - Arquivo openai-client.js n√£o foi carregado');
      console.log('   - Erro de JavaScript impedindo execu√ß√£o');
      console.log('   - Problema na ordem de carregamento dos scripts');
      console.log('   - Conflito de namespace');
      
      window.testeOpenAI = teste;
      return;
    }
    
    // Continuar verificando
    setTimeout(verificarCliente, 500);
  }
  
  teste.inicioTeste = Date.now();
  verificarCliente();
}

// Fun√ß√£o para verificar carregamento de scripts
function verificarScriptsCarregados() {
  console.log('üìú === VERIFICA√á√ÉO DE SCRIPTS CARREGADOS ===');
  
  const scripts = document.querySelectorAll('script');
  const scriptsExtensao = [];
  
  scripts.forEach((script, index) => {
    const src = script.src;
    if (src && (src.includes('openai-client') || src.includes('content-simple') || src.includes('content.js'))) {
      scriptsExtensao.push({
        index,
        src,
        loaded: script.readyState || 'unknown'
      });
    }
  });
  
  console.log('üìã Scripts da extens√£o encontrados:', scriptsExtensao);
  
  // Verificar se os scripts est√£o na ordem correta
  const openaiScript = scriptsExtensao.find(s => s.src.includes('openai-client'));
  const contentScript = scriptsExtensao.find(s => s.src.includes('content'));
  
  if (openaiScript && contentScript) {
    if (openaiScript.index < contentScript.index) {
      console.log('‚úÖ Ordem dos scripts correta: openai-client.js carrega antes do content script');
    } else {
      console.log('‚ùå PROBLEMA: content script carrega antes do openai-client.js');
      console.log('   Isso pode causar problemas de depend√™ncia!');
    }
  }
  
  return scriptsExtensao;
}

// Executar testes espec√≠ficos
setTimeout(() => {
  verificarScriptsCarregados();
  testarOpenAIClient();
}, 1000);

// Fun√ß√£o para debug manual
window.debugLexChat = function() {
  console.log('üîß === DEBUG MANUAL LEX CHAT ===');
  diagnosticarExtensaoLex();
  verificarScriptsCarregados();
  testarOpenAIClient();
};
/
/ Fun√ß√£o para testar extra√ß√£o de informa√ß√µes
function testarExtracao() {
  console.log('üìÑ === TESTE DE EXTRA√á√ÉO DE INFORMA√á√ïES ===');
  
  const info = {};
  const texto = document.body.innerText;
  
  // Testar extra√ß√£o de n√∫mero do processo
  const numeroMatch = texto.match(/(\d{7}-\d{2}\.\d{4}\.\d{1}\.\d{2}\.\d{4})/g);
  if (numeroMatch) {
    info.numeroProcesso = numeroMatch[0];
    console.log('‚úÖ N√∫mero do processo encontrado:', info.numeroProcesso);
  } else {
    console.log('‚ùå N√∫mero do processo n√£o encontrado');
  }
  
  // Testar detec√ß√£o de tribunal
  if (window.location.href.includes('tjsp')) {
    info.tribunal = 'TJSP';
  } else if (window.location.href.includes('tjpa')) {
    info.tribunal = 'TJPA';
  } else if (window.location.href.includes('pje.jus.br')) {
    info.tribunal = 'PJe Nacional';
  }
  
  if (info.tribunal) {
    console.log('‚úÖ Tribunal identificado:', info.tribunal);
  } else {
    console.log('‚ùå Tribunal n√£o identificado');
  }
  
  // Testar detec√ß√£o de documentos
  const embeds = document.querySelectorAll('embed, iframe');
  console.log(`üìã Elementos embed/iframe encontrados: ${embeds.length}`);
  
  embeds.forEach((embed, index) => {
    const src = embed.src || embed.getAttribute('src');
    if (src && (src.includes('documento') || src.includes('pdf'))) {
      console.log(`‚úÖ Documento ${index + 1} encontrado:`, src);
    }
  });
  
  // Salvar resultado
  window.infoExtraida = info;
  console.log('üíæ Informa√ß√µes extra√≠das salvas em window.infoExtraida');
  
  return info;
}

// Fun√ß√£o para corrigir problemas comuns
function corrigirProblemas() {
  console.log('üîß === TENTATIVA DE CORRE√á√ÉO DE PROBLEMAS ===');
  
  // 1. Verificar se OpenAI client n√£o existe e tentar recriar
  if (!window.openaiClient) {
    console.log('üîÑ Tentando recriar OpenAI Client...');
    
    // Tentar executar o c√≥digo do openai-client.js manualmente
    try {
      // Verificar se a classe OpenAIClient existe
      if (typeof OpenAIClient !== 'undefined') {
        window.openaiClient = new OpenAIClient();
        console.log('‚úÖ OpenAI Client recriado com sucesso!');
      } else {
        console.log('‚ùå Classe OpenAIClient n√£o encontrada');
      }
    } catch (error) {
      console.log('‚ùå Erro ao recriar OpenAI Client:', error);
    }
  }
  
  // 2. Verificar se bot√£o n√£o existe e tentar recriar
  const botaoExiste = document.querySelector('.lex-button') || document.querySelector('[id^="pje-assistant-btn-"]');
  if (!botaoExiste) {
    console.log('üîÑ Tentando recriar bot√£o da extens√£o...');
    
    try {
      // Criar bot√£o simples de emerg√™ncia
      const botaoEmergencia = document.createElement('button');
      botaoEmergencia.id = 'lex-emergency-button';
      botaoEmergencia.innerHTML = 'üÜò Lex';
      botaoEmergencia.style.cssText = `
        position: fixed !important;
        top: 10px !important;
        right: 10px !important;
        background: #ff4444 !important;
        color: white !important;
        padding: 10px !important;
        border: none !important;
        border-radius: 5px !important;
        cursor: pointer !important;
        z-index: 999999 !important;
        font-weight: bold !important;
      `;
      
      botaoEmergencia.onclick = function() {
        alert('Bot√£o de emerg√™ncia da Lex ativado!\n\nVerifique o console para diagn√≥sticos.');
        debugLexChat();
      };
      
      document.body.appendChild(botaoEmergencia);
      console.log('‚úÖ Bot√£o de emerg√™ncia criado!');
    } catch (error) {
      console.log('‚ùå Erro ao criar bot√£o de emerg√™ncia:', error);
    }
  }
  
  console.log('üîß Corre√ß√µes aplicadas. Execute debugLexChat() para verificar.');
}