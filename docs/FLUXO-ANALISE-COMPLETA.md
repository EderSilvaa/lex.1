# ğŸ”„ Fluxo Detalhado: AnÃ¡lise Completa de Processo

**Ãšltima atualizaÃ§Ã£o:** 30/09/2025

---

## ğŸ“Š VisÃ£o Geral do Fluxo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USUÃRIO                                  â”‚
â”‚  Clica no botÃ£o "AnÃ¡lise Completa" ğŸ”                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INICIALIZAÃ‡ÃƒO                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Validar nÃºmero do processo                             â”‚ â”‚
â”‚  â”‚ 2. Criar modal de progresso                               â”‚ â”‚
â”‚  â”‚ 3. Instanciar ProcessAnalyzer                             â”‚ â”‚
â”‚  â”‚ 4. Registrar callbacks de progresso                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FASE 1: DESCOBERTA DE DOCUMENTOS                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ProcessCrawler.discoverAllDocuments()                     â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ âœ Detectar estratÃ©gia: DOM Scraping (PJe-TJPA)           â”‚ â”‚
â”‚  â”‚ âœ Buscar: document.querySelectorAll('a[href*="idPro..."]')â”‚ â”‚
â”‚  â”‚ âœ Para cada link encontrado:                              â”‚ â”‚
â”‚  â”‚    â€¢ Extrair: idProcessoDocumento                         â”‚ â”‚
â”‚  â”‚    â€¢ Extrair: nomeArqProcDocBin                           â”‚ â”‚
â”‚  â”‚    â€¢ Extrair: idBin, numeroDocumento                      â”‚ â”‚
â”‚  â”‚    â€¢ Construir URL de download direto                     â”‚ â”‚
â”‚  â”‚    â€¢ Detectar tipo: PDF / HTML / IMAGE                    â”‚ â”‚
â”‚  â”‚ âœ Retornar array de documentos                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Resultado: 10-14 documentos descobertos                        â”‚
â”‚  Tempo mÃ©dio: ~500ms                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FASE 2: DOWNLOAD E PROCESSAMENTO                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ProcessAnalyzer.downloadAndProcess()                      â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ Para cada documento (max 3 paralelos):                    â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚ â”‚ 2.1 VERIFICAR CACHE                          â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ DocumentCache.get(documentId)                â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â”œâ”€ HIT â†’ usar documento cacheado             â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â””â”€ MISS â†’ continuar download                 â”‚          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚ â”‚ 2.2 DOWNLOAD                                 â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ fetch(documentUrl, {                         â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   credentials: 'include',  // usa sessÃ£o PJeâ”‚          â”‚ â”‚
â”‚  â”‚ â”‚   headers: { Accept: 'application/pdf,...' } â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ })                                            â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ Blob baixado (100 KB - 5 MB)                 â”‚          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚ â”‚ 2.3 DETECTAR TIPO                            â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ DocumentDetector.detect(blob, url)           â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â”œâ”€ Content-Type: application/pdf â†’ PDF      â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â”œâ”€ Content-Type: image/* â†’ IMAGE            â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â””â”€ Content-Type: text/html â†’ HTML           â”‚          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚ â”‚ 2.4 PROCESSAR POR TIPO                       â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â”‚     PDF     â”‚  â”‚    IMAGE    â”‚  â”‚ HTML â”‚ â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚ â”‚
â”‚  â”‚ â”‚       â”‚                 â”‚             â”‚      â”‚          â”‚ â”‚
â”‚  â”‚ â”‚       â–¼                 â–¼             â–¼      â”‚          â”‚ â”‚
â”‚  â”‚ â”‚  PDF.js v3.11     Tesseract.js   DOM      â”‚          â”‚ â”‚
â”‚  â”‚ â”‚  extractText()    recognize()     Parser   â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ PÃ¡gina por pÃ¡gina                         â”‚          â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ NormalizaÃ§Ã£o                              â”‚          â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ Metadata                                  â”‚          â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ Stats (pÃ¡ginas, chars)                   â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚  Resultado: texto extraÃ­do                   â”‚          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚ â”‚ 2.5 SALVAR NO CACHE                          â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ DocumentCache.set(documentId, {              â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   content: textoExtraido,                    â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   metadata: { ... },                         â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   timestamp: Date.now(),                     â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   ttl: 3600000  // 1 hora                    â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ })                                            â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â€¢ CompressÃ£o com pako                        â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â€¢ Armazenamento no localStorage              â”‚          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚ â”‚ 2.6 CALLBACK DE PROGRESSO                    â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ onProgress({                                 â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   current: 3,                                â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   total: 14,                                 â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   percentage: 21.4,                          â”‚          â”‚ â”‚
â”‚  â”‚ â”‚   currentDocument: "Doc 03.pdf"              â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ })                                            â”‚          â”‚ â”‚
â”‚  â”‚ â”‚                                               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â†’ Atualizar modal de progresso               â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ â†’ Barra visual 21.4%                         â”‚          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Resultado: 14 documentos processados                           â”‚
â”‚  Tempo mÃ©dio: ~20-40 segundos (depende do tamanho)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FASE 3: PREPARAÃ‡ÃƒO PARA API                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ProcessAnalyzer.prepareForAPI()                           â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ 3.1 CRIAR BATCHES                                          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚ â”‚ createBatches(documents, batchSize=3)          â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ 14 documentos â†’ 5 batches:                      â”‚       â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ Batch 1: [Doc 1, Doc 2, Doc 3]              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ Batch 2: [Doc 4, Doc 5, Doc 6]              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ Batch 3: [Doc 7, Doc 8, Doc 9]              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ Batch 4: [Doc 10, Doc 11, Doc 12]           â”‚       â”‚ â”‚
â”‚  â”‚ â”‚  â€¢ Batch 5: [Doc 13, Doc 14]                   â”‚       â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ 3.2 PREPARAR PAYLOAD PARA CADA BATCH                      â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚ â”‚ Para cada batch:                                â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ const documentosTexto = batch.map(doc => {     â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   // LIMITAR TAMANHO (evita erro 500)          â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   let conteudo = doc.conteudo;                 â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   if (conteudo.length > 15000) {               â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     conteudo = conteudo.substring(0, 15000);   â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     conteudo += '\n[...truncado...]';          â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   }                                             â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   return `                                      â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ ## DOCUMENTO: ${doc.nome}                      â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ Tipo: ${doc.tipo}                              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ ${conteudo}                                     â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ ---`;                                           â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ }).join('\n\n');                                â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ const payload = {                               â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   pergunta: `VocÃª Ã© um assistente jurÃ­dico.    â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     Analise o processo ${processNumber}:       â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     ${documentosTexto}                          â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     ForneÃ§a anÃ¡lise completa...`,              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   contexto: `AnÃ¡lise do processo ${number}`    â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ };                                              â”‚       â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            FASE 4: ENVIO PARA API E ANÃLISE                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ProcessAnalyzer.sendToAPI()                               â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ Para cada batch (sequencial):                              â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚ â”‚ 4.1 ENVIAR BATCH                          â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ fetch(SUPABASE_OPENIA_URL, {              â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   method: 'POST',                         â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   headers: {                               â”‚             â”‚ â”‚
â”‚  â”‚ â”‚     'Authorization': `Bearer ${apiKey}`,  â”‚             â”‚ â”‚
â”‚  â”‚ â”‚     'apikey': apiKey,                     â”‚             â”‚ â”‚
â”‚  â”‚ â”‚     'Content-Type': 'application/json'    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   },                                       â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   body: JSON.stringify(payload)           â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ })                                         â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ Console: "ğŸ“¤ LEX: Enviando batch 1/5..."  â”‚             â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚ â”‚ 4.2 SUPABASE EDGE FUNCTION                â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”‚ Recebe payload                    â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”‚ Valida entrada                    â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”‚ Chama OpenAI GPT-4:               â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”‚   model: "gpt-4"                  â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”‚   max_tokens: 2000                â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”‚   temperature: 0.7                â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â”‚ Retorna resposta                  â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ Tempo mÃ©dio: ~5-10 segundos por batch     â”‚             â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚ â”‚ 4.3 RECEBER RESPOSTA                      â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ {                                          â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   "resposta": "## RESUMO EXECUTIVO\n...  â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                ## PARTES DO PROCESSO\n... â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                ## ANÃLISE TÃ‰CNICA\n...",  â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   "fallback": null                        â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ }                                          â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ allResults.push({                          â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   analise: result.resposta,               â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   resposta: result.resposta               â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ });                                        â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ Console: "âœ… LEX: Batch 1 enviado com..." â”‚             â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚ â”‚ 4.4 TRATAMENTO DE ERROS                   â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ try {                                      â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   // enviar batch                         â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ } catch (error) {                          â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   if (error.name === 'ERR_NETWORK_CHANGED')â”‚            â”‚ â”‚
â”‚  â”‚ â”‚     â†’ ignorar e continuar                 â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   else if (response.status === 500)       â”‚             â”‚ â”‚
â”‚  â”‚ â”‚     â†’ log erro e continuar prÃ³ximo batch  â”‚             â”‚ â”‚
â”‚  â”‚ â”‚   else                                     â”‚             â”‚ â”‚
â”‚  â”‚ â”‚     â†’ log erro e continuar                â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ }                                          â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ Console: "âŒ LEX: Erro ao enviar batch 3" â”‚             â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚              â”‚                                              â”‚ â”‚
â”‚  â”‚              â–¼                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚ â”‚ 4.5 DELAY ENTRE BATCHES                   â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ await delay(1000); // 1 segundo           â”‚             â”‚ â”‚
â”‚  â”‚ â”‚                                            â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â†’ Evita sobrecarga da API                 â”‚             â”‚ â”‚
â”‚  â”‚ â”‚ â†’ Respeita rate limits                    â”‚             â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Resultado: 3-5 anÃ¡lises parciais recebidas                     â”‚
â”‚  Tempo total: ~15-50 segundos (depende do nÃºmero de batches)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          FASE 5: CONSOLIDAÃ‡ÃƒO E EXIBIÃ‡ÃƒO                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ProcessAnalyzer.consolidateResults()                      â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ 5.1 CONSOLIDAR MÃšLTIPLAS RESPOSTAS                        â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚ â”‚ if (allResults.length === 0) {                 â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   return { resumo: 'Nenhum resultado' };      â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ }                                               â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ if (allResults.length === 1) {                 â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   return allResults[0];  // retorna direto     â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ }                                               â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ // MÃºltiplos batches â†’ consolidar              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ return {                                        â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   resumo: allResults                           â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     .map(r => r.resposta || r.resumo)         â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     .join('\n\n'),                             â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   batches: allResults.length,                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   detalhes: allResults                         â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ };                                              â”‚       â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ 5.2 CRIAR RESULTADO FINAL                                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚ â”‚ const result = {                                â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   success: true,                               â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   processNumber: '0003398-66...',             â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   statistics: {                                 â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     totalDocuments: 14,                        â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     processedDocuments: 14,                    â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     failedDocuments: 0,                        â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     cacheHits: 0,                              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     cacheMisses: 14,                           â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     totalSize: '2.5 MB',                       â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     processingTime: 45200                      â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   },                                            â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   analysis: consolidatedResult,                â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   processingTime: 45200                        â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ };                                              â”‚       â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ 5.3 CALLBACK ONCOMPLETE                                   â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚ â”‚ onComplete(result)                              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ â†’ finalizarModalProgresso(modal, result)       â”‚       â”‚ â”‚
â”‚  â”‚ â”‚    â€¢ Ãcone: âœ…                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚    â€¢ Mensagem: "AnÃ¡lise concluÃ­da!"            â”‚       â”‚ â”‚
â”‚  â”‚ â”‚    â€¢ Barra: 100% verde                         â”‚       â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚ 5.4 EXIBIR NO CHAT                                        â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚ â”‚ setTimeout(() => {                              â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   const messagesContainer = ...;               â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   // Extrair texto da anÃ¡lise                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   let analiseTexto =                            â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     result.analysis.resumo ||                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     result.analysis.analise ||                 â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     result.analysis.resposta;                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   const resultMessage = createElement({        â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     className: 'lex-message assistant',        â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     innerHTML: `                                â”‚       â”‚ â”‚
â”‚  â”‚ â”‚       <strong>ğŸ“Š AnÃ¡lise Completa</strong>     â”‚       â”‚ â”‚
â”‚  â”‚ â”‚       ${analiseTexto}                           â”‚       â”‚ â”‚
â”‚  â”‚ â”‚       <em>âœ… ${stats.processed} docs</em>      â”‚       â”‚ â”‚
â”‚  â”‚ â”‚     `                                           â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   });                                           â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   messagesContainer.appendChild(resultMessage);â”‚       â”‚ â”‚
â”‚  â”‚ â”‚                                                  â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   // Remover modal apÃ³s 2 segundos             â”‚       â”‚ â”‚
â”‚  â”‚ â”‚   setTimeout(() => modal.remove(), 2000);      â”‚       â”‚ â”‚
â”‚  â”‚ â”‚ }, 1000);                                       â”‚       â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USUÃRIO VÃŠ RESULTADO                         â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ ğŸ“Š AnÃ¡lise Completa do Processo                 â”‚           â”‚
â”‚  â”‚                                                   â”‚           â”‚
â”‚  â”‚ ## RESUMO EXECUTIVO                             â”‚           â”‚
â”‚  â”‚ O processo 0003398-66.1997.8.14.0301 trata...  â”‚           â”‚
â”‚  â”‚                                                   â”‚           â”‚
â”‚  â”‚ ## PARTES DO PROCESSO                           â”‚           â”‚
â”‚  â”‚ Autor: [...]                                     â”‚           â”‚
â”‚  â”‚ RÃ©u: [...]                                       â”‚           â”‚
â”‚  â”‚                                                   â”‚           â”‚
â”‚  â”‚ ## ANÃLISE TÃ‰CNICA                              â”‚           â”‚
â”‚  â”‚ [...]                                            â”‚           â”‚
â”‚  â”‚                                                   â”‚           â”‚
â”‚  â”‚ âœ… 14 documentos analisados                     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â±ï¸ Timeline Detalhada

| Fase | OperaÃ§Ã£o | Tempo Estimado | ObservaÃ§Ãµes |
|------|----------|----------------|-------------|
| **1** | Descoberta de documentos | ~500ms | Scraping do DOM |
| **2.1** | VerificaÃ§Ã£o de cache (14 docs) | ~100ms | localStorage rÃ¡pido |
| **2.2** | Download (14 docs, paralelo) | ~5-10s | Depende da rede |
| **2.3** | DetecÃ§Ã£o de tipo (14 docs) | ~50ms | Content-Type header |
| **2.4** | Processamento PDF (14 docs) | ~15-25s | PDF.js pÃ¡gina por pÃ¡gina |
| **2.5** | Salvar em cache (14 docs) | ~200ms | CompressÃ£o + localStorage |
| **3** | Criar batches e payloads | ~100ms | OperaÃ§Ã£o em memÃ³ria |
| **4** | Envio para API (5 batches) | ~25-50s | 5-10s por batch + delays |
| **5** | ConsolidaÃ§Ã£o e exibiÃ§Ã£o | ~100ms | OperaÃ§Ã£o em memÃ³ria |
| | **TOTAL** | **45-85 segundos** | Processo mÃ©dio (14 docs) |

---

## ğŸ” Pontos CrÃ­ticos do Fluxo

### 1. **Descoberta de Documentos**
```javascript
// CRÃTICO: Seletor especÃ­fico para PJe-TJPA
const pjeDocLinks = document.querySelectorAll('a[href*="idProcessoDocumento"]');

// Se nÃ£o encontrar nada â†’ FALHA
if (pjeDocLinks.length === 0) {
  console.warn('âš ï¸ Nenhum documento encontrado');
  // Tentar estratÃ©gias alternativas
}
```

**Potenciais problemas:**
- âŒ PJe de outro tribunal (diferente de TJPA)
- âŒ PÃ¡gina nÃ£o carregou completamente
- âŒ Estrutura do HTML mudou

**SoluÃ§Ã£o:**
- âœ… MÃºltiplas estratÃ©gias de descoberta
- âœ… Logging detalhado
- âœ… Mensagem de erro clara ao usuÃ¡rio

---

### 2. **Download de Documentos**
```javascript
// CRÃTICO: SessÃ£o autenticada do PJe
const response = await fetch(documentUrl, {
  credentials: 'include'  // USA COOKIES
});

if (!response.ok) {
  // PossÃ­veis erros: 401, 403, 404, 500
  throw new Error(`Download falhou: ${response.status}`);
}
```

**Potenciais problemas:**
- âŒ SessÃ£o expirou (401/403)
- âŒ Documento nÃ£o existe (404)
- âŒ Servidor sobrecarregado (500/503)
- âŒ Erro de rede

**SoluÃ§Ã£o:**
- âœ… Continua mesmo se alguns docs falharem
- âœ… Log de erros detalhado
- âœ… EstatÃ­sticas mostram docs falhados

---

### 3. **Processamento de PDF**
```javascript
// CRÃTICO: PDF.js precisa estar carregado
if (!window.PDFProcessor) {
  console.error('âŒ PDFProcessor nÃ£o disponÃ­vel');
  return fallbackHTML(url); // usa mÃ©todo alternativo
}

const processor = new window.PDFProcessor();
await processor.initialize(); // verifica window.pdfjsLib
```

**Potenciais problemas:**
- âŒ PDF.js nÃ£o carregou (Manifest V3 issues)
- âŒ PDF corrompido
- âŒ PDF muito grande (>10MB)
- âŒ PDF escaneado (sem texto)

**SoluÃ§Ã£o:**
- âœ… Fallback para HTML se PDF falhar
- âœ… Timeout de 30s por documento
- âœ… Logging de cada etapa

---

### 4. **Envio para API**
```javascript
// CRÃTICO: Tamanho do payload
const payload = {
  pergunta: documentosTexto // PODE SER MUITO GRANDE
};

// Se > 15k chars por doc â†’ erro 500
if (doc.conteudo.length > 15000) {
  doc.conteudo = doc.conteudo.substring(0, 15000);
}
```

**Potenciais problemas:**
- âŒ Payload muito grande (erro 500)
- âŒ Rate limit da OpenAI
- âŒ Timeout (>30s)
- âŒ Erro de rede

**SoluÃ§Ã£o:**
- âœ… Limite de 15k chars por documento
- âœ… Batches de 3 documentos
- âœ… Delay de 1s entre batches
- âœ… Continua se um batch falhar

---

### 5. **Cache**
```javascript
// CRÃTICO: localStorage tem limite de 5-10MB
const cached = DocumentCache.get(documentId);

if (cached) {
  // Verificar se expirou
  if (Date.now() - cached.timestamp > 3600000) {
    // Expirou â†’ remover e reprocessar
    DocumentCache.remove(documentId);
  } else {
    // VÃ¡lido â†’ usar
    return cached;
  }
}
```

**Potenciais problemas:**
- âŒ localStorage cheio (QuotaExceededError)
- âŒ Cache corrompido
- âŒ Dados expirados

**SoluÃ§Ã£o:**
- âœ… CompressÃ£o com pako (reduz 50-70%)
- âœ… TTL de 1 hora (limpa automaticamente)
- âœ… Try-catch em todas operaÃ§Ãµes de cache

---

## ğŸ“ˆ MÃ©tricas de Sucesso

### **O que Ã© considerado sucesso:**
```javascript
// CenÃ¡rio ideal
{
  success: true,
  statistics: {
    totalDocuments: 14,
    processedDocuments: 14,  // âœ… 100% processados
    failedDocuments: 0,
    cacheHits: 0
  }
}

// CenÃ¡rio aceitÃ¡vel
{
  success: true,
  statistics: {
    totalDocuments: 14,
    processedDocuments: 12,  // âœ… >80% processados
    failedDocuments: 2,      // âš ï¸ 2 falharam mas ok
    cacheHits: 5
  }
}

// CenÃ¡rio de falha
{
  success: false,
  statistics: {
    totalDocuments: 14,
    processedDocuments: 3,   // âŒ <20% processados
    failedDocuments: 11,
    error: 'Falha crÃ­tica'
  }
}
```

---

## ğŸ¯ OtimizaÃ§Ãµes PossÃ­veis

### **Curto Prazo:**
1. **PrÃ©-carregar prÃ³ximo documento** enquanto processa atual
2. **Cancelar downloads** se usuÃ¡rio fechar modal
3. **Retry automÃ¡tico** em falhas de rede (max 3 tentativas)

### **MÃ©dio Prazo:**
1. **IndexedDB** ao invÃ©s de localStorage (maior capacidade)
2. **Service Worker** para cache mais robusto
3. **Streaming de respostas** da OpenAI (mais rÃ¡pido)

### **Longo Prazo:**
1. **Processamento no backend** (Supabase Edge Function)
2. **WebSocket** para anÃ¡lise em tempo real
3. **Machine Learning** para priorizar documentos importantes

---

**ğŸ¤– DocumentaÃ§Ã£o gerada automaticamente pela Claude Code**
